# Процесс подготовки релиза Kolibri

## Цель
Этот документ описывает, как выплавить финальный комплект артефактов Kolibri — ядро, загрузочный образ и сопроводительные материалы — и упаковать их в архив для публикации.

## Предварительные требования
- Linux/macOS окружение с установленными зависимостями, перечисленными в `README.md` (включая `cmake`, `gcc`, `nasm`, `grub-mkrescue`, `emcc` для сборки WASM).
- Сборка должна выполняться на чистом дереве Git без незакоммиченных изменений.
- Перед релизом необходимо убедиться, что актуальны `docs/release_notes.md` и `docs/kolibri_integrated_prototype.md`.

## Быстрый сценарий
```bash
./scripts/package_release.sh --skip-cluster
```
Скрипт выполнит полный цикл `run_all.sh`, соберёт `kolibri.wasm`, `kolibri.iso`, сгенерирует контрольные суммы и сформирует архив `build/release/kolibri-<дата>.tar.gz`. Флаги `--skip-iso`, `--skip-wasm`, `--skip-cluster` позволяют временно исключать шаги при отсутствии соответствующих инструментов.

## Аудит готовности перед упаковкой
- Запустите `./scripts/release_audit.py`, чтобы убедиться в наличии ключевых документов, актуальности релизных заметок и артефактов сборки.
- Добавьте `--require-artifacts`, если ожидаете увидеть собранные `build/kolibri.iso` и `build/wasm/kolibri.wasm` (отсутствие файлов в этом режиме приведёт к ошибке).
- Используйте `--run-tests`, чтобы автоматически прогнать стандартные проверки (`pytest -q`, `ruff check .`, `pyright`, `ctest --test-dir build`). Опция `--tests` принимает собственные команды строками, например `--tests "pytest -q" "ninja -C build"`.
- Флаги `--require-clean` и `--require-release-archive` заставляют аудит дополнительно проверять чистоту дерева Git и наличие свежего архива в `build/release/`. Опция `--fail-on-warnings` переводит предупреждения в статус ошибки, а `--json-output <путь>` сохраняет машинно-читаемый отчёт.

## Подробные шаги
1. Выполнить `./scripts/run_all.sh` и убедиться, что сборка и тесты завершаются без ошибок.
2. Проверить размер `build/wasm/kolibri.wasm` — он не должен превышать 1 МБ (гейт из `AGENTS.md`).
3. При наличии кросс-компилятора собрать `build/kolibri.iso` и протестировать загрузку в `qemu-system-i386`:
   ```bash
   qemu-system-i386 -cdrom build/kolibri.iso -monitor stdio
   ```
4. Запустить `./scripts/package_release.sh` и дождаться сообщения `[Готово]` с путём к архиву.
5. Содержимое архива:
   - `kolibri.wasm`, `kolibri.wasm.sha256`
   - `kolibri.iso`
   - `README.md`, `LICENSE`, `release_notes.md`, `kolibri_integrated_prototype.md`
   - `METADATA.txt` с фиксацией коммита и времени сборки
6. Архив можно загружать в GitHub Releases, а контрольные суммы использовать для проверки целостности.

## Проверка на «зелёный коридор»
- `cmake`, `ctest` — зелёные.
- `./scripts/run_all.sh --skip-cluster --skip-iso --skip-wasm` — зелёный минимум.
- `./scripts/package_release.sh --skip-cluster` — завершился успешно и создал архив.

## Советы
- Для воспроизводимости фиксируйте `SOURCE_DATE_EPOCH` и используйте одну и ту же версию инструментов.
- Если `grub-mkrescue` или `emcc` недоступны, запустите скрипт с `--skip-iso` или `--skip-wasm`, а затем подготовьте соответствующие артефакты на машине с нужными зависимостями.
- Сохраняйте артефакты и метрики минимум 30 дней, как требует политика репозитория.
